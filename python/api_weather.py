"""
FarmTech Solutions - Integra√ß√£o API Meteorol√≥gica
Consulta previs√£o do tempo para otimizar irriga√ß√£o no sistema ESP32
Vers√£o 2.0 - Compat√≠vel com prog1.ino atualizado
"""

import requests
import json
import time
from datetime import datetime, timedelta
import sys

class WeatherAPI:
    def __init__(self, api_key, cidade="S√£o Paulo"):
        self.api_key = api_key
        self.cidade = cidade
        self.base_url = "http://api.openweathermap.org/data/2.5"
        
    def consultar_previsao(self):
        """Consulta previs√£o do tempo nas pr√≥ximas 6 horas"""
        try:
            url = f"{self.base_url}/forecast"
            params = {
                'q': self.cidade,
                'appid': self.api_key,
                'units': 'metric',
                'cnt': 2  # Pr√≥ximas 6 horas (2 per√≠odos de 3h)
            }
            
            response = requests.get(url, params=params)
            response.raise_for_status()
            data = response.json()
            
            # Verifica se h√° previs√£o de chuva
            vai_chover = False
            intensidade_chuva = 0
            descricao = "Limpo"
            
            for forecast in data['list']:
                if 'rain' in forecast:
                    vai_chover = True
                    # Soma a intensidade da chuva (mm/3h)
                    intensidade_chuva += forecast['rain'].get('3h', 0)
                    descricao = forecast['weather'][0]['description']
                elif 'snow' in forecast:
                    vai_chover = True
                    intensidade_chuva += forecast['snow'].get('3h', 0)
                    descricao = forecast['weather'][0]['description']
                else:
                    descricao = forecast['weather'][0]['description']
            
            return {
                'vai_chover': vai_chover,
                'intensidade': round(intensidade_chuva, 1),
                'descricao': descricao,
                'timestamp': datetime.now().isoformat()
            }
            
        except requests.exceptions.RequestException as e:
            print(f"‚ùå Erro de conex√£o: {e}")
            return self._retorno_erro()
        except KeyError as e:
            print(f"‚ùå Erro nos dados da API: {e}")
            return self._retorno_erro()
        except Exception as e:
            print(f"‚ùå Erro inesperado: {e}")
            return self._retorno_erro()
    
    def consultar_tempo_atual(self):
        """Consulta condi√ß√µes meteorol√≥gicas atuais"""
        try:
            url = f"{self.base_url}/weather"
            params = {
                'q': self.cidade,
                'appid': self.api_key,
                'units': 'metric'
            }
            
            response = requests.get(url, params=params)
            response.raise_for_status()
            data = response.json()
            
            return {
                'temperatura': round(data['main']['temp'], 1),
                'umidade_ar': data['main']['humidity'],
                'pressao': data['main']['pressure'],
                'descricao': data['weather'][0]['description'],
                'vento': round(data['wind']['speed'], 1),
                'nuvens': data['clouds']['all']
            }
            
        except Exception as e:
            print(f"‚ùå Erro ao consultar tempo atual: {e}")
            return None
    
    def _retorno_erro(self):
        """Retorna valores padr√£o em caso de erro"""
        return {
            'vai_chover': False,
            'intensidade': 0.0,
            'descricao': 'Erro na consulta',
            'timestamp': datetime.now().isoformat()
        }

class ESP32CodeGenerator:
    """Gera c√≥digo C++ para ser copiado no ESP32"""
    
    def __init__(self):
        self.dados_gerados = []
    
    def gerar_codigo_cpp(self, previsao, tempo_atual=None):
        """Gera c√≥digo C++ para ser copiado no prog1.ino"""
        
        # Determinar valores booleanos
        vai_chover = previsao['vai_chover']
        intensidade = previsao['intensidade']
        descricao = previsao['descricao']
        
        # Gerar c√≥digo C++
        codigo_cpp = f"""
// ===== DADOS METEOROL√ìGICOS ATUALIZADOS =====
// Gerado automaticamente em: {datetime.now().strftime("%Y-%m-%d %H:%M:%S")}
// Cidade: Consultada via API OpenWeather

bool previsao_chuva = {"true" if vai_chover else "false"};
float intensidade_chuva = {intensidade}f;
String condicao_tempo = "{descricao}";
"""
        
        # Adicionar coment√°rios explicativos
        comentarios = f"""
/*
 * INSTRU√á√ïES PARA USO NO WOKWI:
 * 1. Copie as 3 linhas acima
 * 2. Substitua as vari√°veis correspondentes no prog1.ino
 * 3. Recompile o c√≥digo no Wokwi
 * 4. Teste o comportamento do sistema
 * 
 * DADOS DA CONSULTA:
 * - Timestamp: {previsao['timestamp']}
 * - Vai chover: {"Sim" if vai_chover else "N√£o"}
 * - Intensidade: {intensidade} mm
 * - Condi√ß√£o: {descricao}
"""
        
        if tempo_atual:
            comentarios += f"""
 * 
 * CONDI√á√ïES ATUAIS:
 * - Temperatura: {tempo_atual['temperatura']}¬∞C
 * - Umidade ar: {tempo_atual['umidade_ar']}%
 * - Press√£o: {tempo_atual['pressao']} hPa
 * - Vento: {tempo_atual['vento']} m/s
 */
"""
        else:
            comentarios += " */"
        
        return codigo_cpp + comentarios
    
    def salvar_dados_csv(self, previsao, tempo_atual, arquivo="dados_meteorologicos.csv"):
        """Salva dados em CSV para an√°lise posterior"""
        import csv
        import os
        
        # Verificar se arquivo existe para adicionar cabe√ßalho
        arquivo_existe = os.path.exists(arquivo)
        
        with open(arquivo, 'a', newline='', encoding='utf-8') as csvfile:
            fieldnames = ['timestamp', 'vai_chover', 'intensidade_chuva', 'descricao',
                         'temperatura', 'umidade_ar', 'pressao', 'vento']
            
            writer = csv.DictWriter(csvfile, fieldnames=fieldnames)
            
            # Escrever cabe√ßalho se arquivo n√£o existir
            if not arquivo_existe:
                writer.writeheader()
            
            # Preparar dados
            dados = {
                'timestamp': previsao['timestamp'],
                'vai_chover': previsao['vai_chover'],
                'intensidade_chuva': previsao['intensidade'],
                'descricao': previsao['descricao'],
                'temperatura': tempo_atual['temperatura'] if tempo_atual else 'N/A',
                'umidade_ar': tempo_atual['umidade_ar'] if tempo_atual else 'N/A',
                'pressao': tempo_atual['pressao'] if tempo_atual else 'N/A',
                'vento': tempo_atual['vento'] if tempo_atual else 'N/A'
            }
            
            writer.writerow(dados)
            self.dados_gerados.append(dados)

def exibir_banner():
    """Exibe banner inicial do programa"""
    print("="*60)
    print("üå± FarmTech Solutions - Weather API Integration v2.0")
    print("üå§Ô∏è  Integra√ß√£o com OpenWeatherMap para Sistema de Irriga√ß√£o")
    print("üì° Compat√≠vel com prog1.ino v2.0")
    print("="*60)

def obter_api_key():
    """Obt√©m API key do arquivo .env ou solicita input"""
    import os
    from dotenv import load_dotenv
    
    # Carregar vari√°veis do arquivo .env
    load_dotenv()
    
    # Tentar obter da vari√°vel de ambiente (.env)
    api_key = os.getenv('OPENWEATHER_API_KEY')
    
    if api_key:
        print("üîë API Key carregada do arquivo .env")
        return api_key
    
    # Se n√£o encontrou no .env, solicitar input
    print("\nüîë API Key n√£o encontrada no arquivo .env!")
    print("üìã Para obter uma API key gratuita:")
    print("   1. Acesse: https://openweathermap.org/api")
    print("   2. Crie uma conta gratuita")
    print("   3. Copie sua API key")
    print("   4. Adicione no arquivo .env: OPENWEATHER_API_KEY=sua_key_aqui")
    print()
    
    api_key = input("üîë Digite sua API key do OpenWeatherMap: ").strip()
    
    if not api_key:
        print("‚ùå API key √© obrigat√≥ria!")
        return None
    
    return api_key

def main():
    """Fun√ß√£o principal do programa"""
    
    exibir_banner()
    
    # Carregar configura√ß√µes do .env
    from dotenv import load_dotenv
    import os
    
    load_dotenv()
    
    # Configura√ß√µes (com fallback para valores padr√£o)
    CIDADE = os.getenv('CIDADE', 'S√£o Paulo')
    MODO_DEMONSTRACAO = os.getenv('MODO_SIMULACAO', 'True').lower() != 'false'
    
    # Obter API key
    api_key = obter_api_key()
    if not api_key:
        print("‚ùå Programa encerrado - API key necess√°ria")
        return
    
    # Inicializar componentes
    weather = WeatherAPI(api_key, CIDADE)
    code_gen = ESP32CodeGenerator()
    
    print(f"\nüèôÔ∏è  Cidade configurada: {CIDADE}")
    print(f"üîß Modo demonstra√ß√£o: {'Ativo' if MODO_DEMONSTRACAO else 'Loop cont√≠nuo'}")
    print("\nüîÑ Iniciando consultas meteorol√≥gicas...")
    
    try:
        num_consultas = 3 if MODO_DEMONSTRACAO else 999999
        
        for i in range(num_consultas):
            print(f"\n{'='*50}")
            print(f"üîÑ CONSULTA {i+1}" + (f"/{num_consultas}" if MODO_DEMONSTRACAO else ""))
            print(f"üïê {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
            print("="*50)
            
            # Consultar APIs
            print("üì° Consultando previs√£o meteorol√≥gica...")
            previsao = weather.consultar_previsao()
            
            print("üì° Consultando condi√ß√µes atuais...")
            tempo_atual = weather.consultar_tempo_atual()
            
            # Exibir resultados
            print(f"\nüìä === DADOS METEOROL√ìGICOS ===")
            
            if tempo_atual:
                print(f"üå°Ô∏è  Temperatura atual: {tempo_atual['temperatura']}¬∞C")
                print(f"üíß Umidade do ar: {tempo_atual['umidade_ar']}%")
                print(f"üå™Ô∏è  Vento: {tempo_atual['vento']} m/s")
                print(f"‚òÅÔ∏è  Nuvens: {tempo_atual['nuvens']}%")
                print(f"üå§Ô∏è  Condi√ß√£o atual: {tempo_atual['descricao']}")
            
            print(f"\nüåßÔ∏è  Previs√£o (pr√≥ximas 6h):")
            print(f"   Vai chover: {'Sim' if previsao['vai_chover'] else 'N√£o'}")
            print(f"   Intensidade: {previsao['intensidade']} mm")
            print(f"   Condi√ß√£o: {previsao['descricao']}")
            
            # Gerar c√≥digo C++
            codigo_cpp = code_gen.gerar_codigo_cpp(previsao, tempo_atual)
            
            # Salvar dados em CSV
            code_gen.salvar_dados_csv(previsao, tempo_atual)
            
            # Exibir instru√ß√µes
            print(f"\n{'='*60}")
            print("üìã C√ìDIGO PARA COPIAR NO WOKWI (prog1.ino):")
            print("="*60)
            print(codigo_cpp)
            print("="*60)
            
            # Recomenda√ß√µes baseadas nos dados
            print(f"\nüí° RECOMENDA√á√ïES PARA O SISTEMA:")
            if previsao['vai_chover']:
                if previsao['intensidade'] > 5.0:
                    print("üö® Chuva intensa prevista - Suspender irriga√ß√£o imediatamente")
                    print("üì§ Comando sugerido: PARADA_FORCADA")
                else:
                    print("üåßÔ∏è Chuva leve prevista - Reduzir irriga√ß√£o")
                    print("üì§ Comando sugerido: SUSPENDER_CHUVA")
            else:
                print("‚òÄÔ∏è Sem chuva prevista - Irriga√ß√£o normal permitida")
                print("üì§ Comando sugerido: PERMITIR_IRRIGACAO")
            
            # Aguardar pr√≥xima consulta
            if i < num_consultas - 1:
                intervalo = 10 if MODO_DEMONSTRACAO else 300  # 10s demo, 5min produ√ß√£o
                print(f"\n‚è∞ Aguardando {intervalo} segundos para pr√≥xima consulta...")
                
                if MODO_DEMONSTRACAO:
                    print("üí° Pressione Ctrl+C para interromper")
                
                time.sleep(intervalo)
        
        # Resumo final
        print(f"\n{'='*60}")
        print("üìä RESUMO DA SESS√ÉO:")
        print(f"‚úÖ {len(code_gen.dados_gerados)} consultas realizadas com sucesso")
        print(f"üíæ Dados salvos em: dados_meteorologicos.csv")
        print("üéØ C√≥digos C++ gerados e prontos para uso no Wokwi")
        print("="*60)
            
    except KeyboardInterrupt:
        print("\n‚èπÔ∏è  Interrompido pelo usu√°rio")
    except Exception as e:
        print(f"\n‚ùå Erro inesperado: {e}")
    
    finally:
        print("\nüèÅ FarmTech Weather Integration finalizado")
        print("üí° Para usar os dados:")
        print("   1. Copie o c√≥digo C++ gerado")
        print("   2. Substitua as vari√°veis no prog1.ino")
        print("   3. Recompile no Wokwi")
        print("   4. Teste o comportamento do sistema")

if __name__ == "__main__":
    print("üêç Iniciando FarmTech Weather Integration...")
    print("üí° Pressione Ctrl+C a qualquer momento para parar")
    print()
    
    # Verificar se bibliotecas est√£o instaladas
    try:
        import requests
        from dotenv import load_dotenv
    except ImportError as e:
        if 'requests' in str(e):
            print("‚ùå Biblioteca 'requests' n√£o encontrada!")
            print("üì¶ Instale com: pip install requests")
        elif 'dotenv' in str(e):
            print("‚ùå Biblioteca 'python-dotenv' n√£o encontrada!")
            print("üì¶ Instale com: pip install python-dotenv")
        else:
            print(f"‚ùå Biblioteca n√£o encontrada: {e}")
            print("üì¶ Instale com: pip install requests python-dotenv")
        sys.exit(1)
    
    main()